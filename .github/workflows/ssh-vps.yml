name: SSH to VPS

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  ssh-to-vps:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        env:
          VPS_IP: ${{ secrets.VPS_IP }}
          VPS_M: ${{ secrets.VPS_M }}
        run: |
          # Create SSH directory
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Save SSH private key from secrets
          echo "$VPS_M" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Add VPS to known hosts to avoid host key verification prompt
          ssh-keyscan -H "$VPS_IP" >> ~/.ssh/known_hosts 2>/dev/null || true
          
          echo "SSH setup completed"
      
      - name: Test SSH Connection
        env:
          VPS_IP: ${{ secrets.VPS_IP }}
        run: |
          # Test SSH connection
          ssh -o ConnectTimeout=10 root@$VPS_IP "echo 'Successfully connected to VPS'; hostname; uptime" || \
          echo "SSH connection failed. Please check VPS_IP and VPS_M secrets are correctly configured."
