name: Observing From Tophub

on:
  workflow_run:
    workflows:
      - Tophub Entertainment Daily
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  GEMINI: ${{ secrets.GEMINI }}
  GEMINI_MODEL: ${{ secrets.GEMINI_MODEL }}

jobs:
  generate:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref_name }}

      - name: Validate Gemini secret
        shell: bash
        run: |
          if [ -z "${GEMINI_API_KEY:-${GEMINI:-}}" ]; then
            echo "Missing GEMINI_API_KEY (or GEMINI) secret."
            exit 1
          fi

      - name: Wait 5 minutes after Tophub workflow
        if: ${{ github.event_name == 'workflow_run' }}
        shell: bash
        run: sleep 300

      - name: Extract five hot events from output/summary.md
        id: extract
        shell: bash
        run: |
          SUMMARY_FILE="output/summary.md"
          if [ ! -f "$SUMMARY_FILE" ]; then
            echo "Missing $SUMMARY_FILE. Run Tophub workflow first so it commits output files."
            exit 1
          fi

          mapfile -t EVENTS < <(
            awk '
              /^##[[:space:]]+热点事件/ {in_section=1; next}
              /^##[[:space:]]+/ {if (in_section) exit}
              in_section && /^-[[:space:]]+/ {
                sub(/^-+[[:space:]]*/, "", $0)
                gsub(/\r/, "", $0)
                if (length($0) > 0) print $0
              }
            ' "$SUMMARY_FILE" | head -n 5
          )

          if [ "${#EVENTS[@]}" -lt 5 ]; then
            echo "Expected 5 hot events in $SUMMARY_FILE, got ${#EVENTS[@]}"
            printf '%s\n' "${EVENTS[@]}"
            exit 1
          fi

          for i in 1 2 3 4 5; do
            EVENT="${EVENTS[$((i - 1))]}"
            {
              echo "event${i}<<EOF"
              echo "$EVENT"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          done

      - name: Generate note for event 1
        uses: ./observing
        with:
          observation: ${{ steps.extract.outputs.event1 }}
          scenario: TopHub 娱乐热点日报（output/summary.md）
          perspective: 娱乐内容观察者
          output_dir: output/observing
          gemini_model: ${{ env.GEMINI_MODEL }}

      - name: Generate note for event 2
        uses: ./observing
        with:
          observation: ${{ steps.extract.outputs.event2 }}
          scenario: TopHub 娱乐热点日报（output/summary.md）
          perspective: 娱乐内容观察者
          output_dir: output/observing
          gemini_model: ${{ env.GEMINI_MODEL }}

      - name: Generate note for event 3
        uses: ./observing
        with:
          observation: ${{ steps.extract.outputs.event3 }}
          scenario: TopHub 娱乐热点日报（output/summary.md）
          perspective: 娱乐内容观察者
          output_dir: output/observing
          gemini_model: ${{ env.GEMINI_MODEL }}

      - name: Generate note for event 4
        uses: ./observing
        with:
          observation: ${{ steps.extract.outputs.event4 }}
          scenario: TopHub 娱乐热点日报（output/summary.md）
          perspective: 娱乐内容观察者
          output_dir: output/observing
          gemini_model: ${{ env.GEMINI_MODEL }}

      - name: Generate note for event 5
        uses: ./observing
        with:
          observation: ${{ steps.extract.outputs.event5 }}
          scenario: TopHub 娱乐热点日报（output/summary.md）
          perspective: 娱乐内容观察者
          output_dir: output/observing
          gemini_model: ${{ env.GEMINI_MODEL }}

      - name: Upload observing artifacts
        uses: actions/upload-artifact@v4
        with:
          name: observing-from-tophub
          path: output/observing/

      - name: Commit generated notes
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f output/observing
          if git diff --cached --quiet; then
            echo "No note changes to commit."
          else
            git commit -m "chore: generate observing notes from tophub hot events"
            git push
          fi
